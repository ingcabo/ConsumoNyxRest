var interceptor = function($q){





return{

		request: function(config){
			
			
								
				
			
				if ((config.url == 'http://127.0.0.1/NyxapiRest/index.php/Users/session') && (config.method == "PUT")){

					config.headers['key']  = 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx';

				}
				
			
				return config;	
		},

		response: function (result) {
         
                return result;
            },
		responseError:function(rejection){
			

			if (rejection.status != 200){

				
				localStorage.setItem('hacer', 'salir');
				

			}


			return rejection;	

		}

	}

};




var app = angular.module('angularTable',['angularUtils.directives.dirPagination','ui.bootstrap','ngRoute','angular-storage']);

app.constant('CONFIG', {
	APIURL: "",
})

.config(["$routeProvider","$httpProvider",function ($routeProvider,$httpProvider) { 




$httpProvider.interceptors.push(interceptor);




$routeProvider.when('/', {
        redirectTo: "/home"
    })
    .when("/home", {
        templateUrl: 'compra.html',
        controller: 'listdata',
        authorization: true
    })
    .when("/login", {
        templateUrl: 'login.html',
        controller: 'loginCtrl',
        authorization: false
    })
    .when("/salir", {
        templateUrl: 'login.html',
        controller: 'salirCtrl',
        authorization: false
    })





}])

.controller('loginCtrl', ['$scope','CONFIG', 'authFactory',  'store', '$location', function($scope, CONFIG, authFactory, store, $location)
{
	$scope.mensajerest="";
	$scope.login = function(user)
    {
        authFactory.login(user).then(function(res)
        {
          
        	
            if(res.data && res.data.message == "Bienvenido")
            {
               
                
                store.set('key', res.data.key);
                $location.path("/home");
				$scope.qhacer = "salir";
                localStorage.setItem('hacer', 'Nosalir');
            }else{


				$scope.mensajerest = res.data.message;

            }

         





        });
    }
}])

.controller('salirCtrl', ['$scope','CONFIG', 'authFactory',  'store', '$location', function($scope, CONFIG, authFactory, store, $location)
{


		

		$scope.salir=function(){
 			localStorage.removeItem("key");
			 $location.path("/login");

		};

			$scope.actualizar=function(){
				


				  $scope.loading = true;	
				  $location.path("/home");
				  $scope.loading = false;	


		}



                

    
}])

.factory("authFactory", ["$http", "$q", "CONFIG",'$location', function($http, $q, CONFIG,$location)
{
	return {
		login: function(user)
		{
			var deferred;
			
            deferred = $q.defer();
            $http({
                method: 'put',
         
                url: 'http://127.0.0.1/NyxapiRest/index.php/Users/session',
                data: "username=" + user.username + "&password=" + user.password,
                headers: {'Content-Type': 'application/x-www-form-urlencoded'}
            })
            .then(function(res)
            {
           	  
              deferred.resolve(res);



            })
            .then(function(error)
            {
              
            	//console.log(error);
                deferred.reject(error);
            })
            return deferred.promise;
		}
	}








}])

.run(["$rootScope",  'store', '$location','$http', function($rootScope, store, $location,$http)
{
    $rootScope.$on('$routeChangeStart', function (event, next) 
    {


        var Hacer = localStorage.getItem("hacer");
        var key = store.get("key") || null;
        
        if (Hacer== "salir"){

			 $location.path("/login");
		}


     
    });


   $rootScope.$watch(function() {
          return localStorage.getItem('key');
    }, function(key) {


    		function replaceAll(text, busca, reemplaza ){

	 					 while (text.toString().indexOf(busca) != -1)
	      				text = text.toString().replace(busca,reemplaza);
	  					return text;

			}

			var newKey = replaceAll(key,"\"","");
       $http.defaults.headers.common.key = newKey;
    });


   $rootScope.$watch(localStorage.getItem("hacer"), function() {
   
    return localStorage.getItem('hacer');
});




		


}])





.controller('listdata', function($scope,$http,$uibModal){

		 $scope.loading = true;	


		 angular.element(document).ready(function () {
    		
    		$scope.getCompras();
   	 });
		


		$scope.getCompras=function(){
				$scope.compras=[];
				$scope.idtext2='';
				$scope.url = "http://127.0.0.1/NyxapiRest/index.php/Myquery/compra/";
				$http.get($scope.url+$scope.idtext2)
				.success(function(data){
				
				$scope.compras = data;
				$scope.loading = false;	
			
				})
				.error(function(data){
				
				
				$scope.loading = false;	
				$scope.compras = data;
				});

				
				$scope.sort =function(keyname){
					
						$scope.sortKey=keyname;
						$scope.reverse=!$scope.reverse;
				
				
				}

			}


			     


				$scope.showDetalle = function(idlote){
     			
					
     				var modalInstanced = $uibModal.open({
					templateUrl: 'detallecompra.html',
					controller : 'detalleController',
					windowClass: 'large-Modal',
					 resolve: {
       							   idlote: function() {
       								return idlote;
       							   }
      							}

						});




					

				};



					$scope.showTraking = function(idlote,item){
     			
					
     				var modalInstance = $uibModal.open({
					templateUrl: 'trakingcompra.html',
					controller : 'trakingController',
					windowClass: 'large-Modal',
					 backdrop: 'static',
  					keyboard: false,
					resolve: {
		       							   idlote: function() {
		       								
		       								$scope.idlote =idlote; 
		       								return idlote;
		       							   },

		       							   item:function(){
		       							   
		       							 
											return $scope.item;
											
										 }
      							}

						});


     							modalInstance.result.then(function(selectedItem){
     					

     									

											$scope.paramt = {
											'id_lote'     : selectedItem.id_lote,
											'empresa_env' : selectedItem.empresa_env,
											'descripcion' : selectedItem.descripcion
												};
							


												
										
																
										$scope.AddTraking($scope.paramt);



										
										
     							},

     								function (selectedItem) {
										   return false;
										}

     							);			

				};









})
.controller('detalleController',function($scope,$http,idlote,$uibModalInstance){

				
					$scope.loadingd = true;	
 					angular.element(document).ready(function () {
    					
    					$scope.getComprast();
    					$scope.getComprasd();

   					 });
		



				$scope.cancel=function(){
				$uibModalInstance.dismiss('cancel');
				};





				$scope.getComprasd=function(){
				$scope.comprasd=[];
				$scope.idtext2= idlote;
				$scope.url = "http://127.0.0.1/NyxapiRest/index.php/Myquery/detallecompra/";
				$http.get($scope.url+$scope.idtext2)
				.success(function(data){

			
				
				$scope.comprasd = data.data;
				
				$scope.loadingd = false;	
				
						
				})
				.error(function(data){
				
				$scope.loadingd = false;
				$scope.comprasd = data;
				});		
		
		}



		$scope.getComprast=function(){
				$scope.comprasd=[];
				$scope.idtext3= idlote;
				$scope.urlt = "http://127.0.0.1/NyxapiRest/index.php/Myquery/compra/";
				$http.get($scope.urlt+$scope.idtext3)
				.success(function(data){
				
			
				$scope.compraT = data.data;
				$scope.compraTk = data.track;

				

				if ($scope.compraT[0].estado_compra == 'Aprobada') {
				    $scope.valert = "alert alert-success";
				}else {

					$scope.valert= "alert alert-danger";
				}
						
				})
				.error(function(data){
				
			
				$scope.compraT = data;
				});		
		
		}

		$scope.sort =function(keyname){
					
						$scope.sortKey=keyname;
						$scope.reverse=!$scope.reverse;
				
				
				}

	})

.controller('trakingController',function($scope,idlote,$http,$uibModalInstance,item){


				$scope.item = item;	

				 $scope.loadingt = true;	

				angular.element(document).ready(function () {
    					
    					$scope.getComprast();
    					$scope.gettrakings();
    			 });







				

				$scope.salvartraking=function(){

				$scope.loadingt = true;	
				$scope.item.id_lote =idlote;
				$scope.paramt = $scope.item;
				
				


				$scope.url = "http://127.0.0.1/NyxapiRest/index.php/Myquery/traking";
											$http.put($scope.url,$scope.paramt)
											.success(function(data,status,headers,config){
											

											
											$scope.loadingt = true;
											$scope.AddTraking={};
											$scope.item = {};
										

									

													$scope.comprasd=[];
													$scope.idtext3= idlote;
													$scope.urlt = "http://127.0.0.1/NyxapiRest/index.php/Myquery/traking/";
													$http.get($scope.urlt+$scope.idtext3)
													.success(function(data){
													
													$scope.loadingt = false;
													$scope.trakings = data.data;

												
															
													})
													.error(function(data){
													
													
													$scope.loadingt = false;
													$scope.trakings = data;
													});

												
											 

											})
											.error(function(error,status,headers,config){
											
											
											
											});
				
				};



				$scope.cancel=function(){
				
				$uibModalInstance.dismiss('cancel');
				
				};

				$scope.AddTraking = function(paramt){
			
										
											$scope.url = "http://127.0.0.1/NyxapiRest/index.php/Myquery/traking";
											$http.put($scope.url,$scope.paramt)
											.success(function(data,status,headers,config){
											

											
											$scope.AddTraking={};
											$scope.item = {};
											
											
											 

											})
											.error(function(error,status,headers,config){
											
											
											
											});
											
			
			};


				$scope.getComprast=function(){
				$scope.comprasd=[];
				$scope.idtext3= idlote;
				$scope.urlt = "http://127.0.0.1/NyxapiRest/index.php/Myquery/compra/";
				$http.get($scope.urlt+$scope.idtext3)
				.success(function(data){
				
			
				$scope.compraT = data.data;

				if ($scope.compraT[0].estado_compra == 'Aprobada') {
				    $scope.valert = "alert alert-success";
				}else {

					$scope.valert= "alert alert-danger";
				}
						
				})
				.error(function(data){
				
				
				$scope.compraT = data;
				});		
		
		}

		$scope.gettrakings=function(){
				$scope.comprasd=[];
				$scope.idtext3= idlote;
				$scope.urlt = "http://127.0.0.1/NyxapiRest/index.php/Myquery/traking/";
				$http.get($scope.urlt+$scope.idtext3)
				.success(function(data){
				
				$scope.loadingt = false;
				$scope.trakings = data.data;

			
						
				})
				.error(function(data){
				
				
				$scope.trakings = data;
				});		
		
		}












});







